version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - node --version
        # CRITICAL: Copy PostgreSQL schema BEFORE npm ci
        # This ensures postinstall script uses the correct schema
        - echo "=== Copying PostgreSQL schema for staging ==="
        - cp prisma/schema-postgres.prisma prisma/schema.prisma
        - cat prisma/schema.prisma | head -20
        # Clean any cached Prisma client to force fresh generation
        - rm -rf node_modules/.prisma node_modules/@prisma/client
        - npm ci
        # Verify Prisma client was generated with correct schema
        - echo "=== Verifying Prisma client generation ==="
        - npx prisma generate
        # Verify Prisma binaries were generated
        - echo "Checking for Prisma binaries..."
        - ls -la node_modules/.prisma/client/*.node || echo "Prisma binaries not found!"
        # Run database migrations (PostgreSQL via DATABASE_URL env var)
        - npx prisma migrate deploy
        # Seed historical tournament data (only if SEED_HISTORY env var is set)
        - if [ "$SEED_HISTORY" = "true" ]; then npm run db:seed-history; fi
    build:
      commands:
        - npm run build
        # Verify Prisma binaries were generated
        - echo "=== Verifying Prisma binaries for AWS Lambda ==="
        - find node_modules/.prisma/client -name "*rhel-openssl-3.0.x.so.node" -ls || echo "RHEL binary NOT FOUND!"
        # CRITICAL: Copy Prisma binaries to Next.js standalone output
        - echo "=== Copying Prisma binaries to standalone output ==="
        - mkdir -p .next/standalone/node_modules/.prisma
        - cp -r node_modules/.prisma/client .next/standalone/node_modules/.prisma/
        - mkdir -p .next/standalone/node_modules/@prisma
        - cp -r node_modules/@prisma/client .next/standalone/node_modules/@prisma/
        - echo "=== Verifying Prisma binaries in standalone ==="
        - ls -la .next/standalone/node_modules/.prisma/client/*.node || echo "Copy failed!"
        # Copy static files to standalone (server files already exist from standalone build)
        - echo "=== Setting up standalone output ==="
        - echo "Checking what standalone build created:"
        - ls -la .next/standalone/.next/ || echo "No .next in standalone"
        - echo "Copying static assets:"
        - cp -r .next/static .next/standalone/.next/static
        - cp -r public .next/standalone/public
        # Copy manifest files to root for Amplify
        - echo "Copying manifest files:"
        - cp .next/required-server-files.json .next/standalone/required-server-files.json || echo "No required-server-files.json"
        - cp .next/routes-manifest.json .next/standalone/routes-manifest.json || echo "No routes-manifest.json"
        - cp .next/prerender-manifest.json .next/standalone/prerender-manifest.json || echo "No prerender-manifest.json"
        - echo "=== Verifying standalone structure ==="
        - ls -la .next/standalone/
        - ls -la .next/standalone/.next/server/ || echo "No server directory in standalone"
        - echo "Checking for trace files in server/app:"
        - find .next/standalone/.next/server/app -name "*.nft.json" -o -name "*.js" | head -20 || echo "No trace files in app"
        - echo "Checking for trace files in server/pages:"
        - find .next/standalone/.next/server/pages -name "*.nft.json" -o -name "*.js" | head -20 || echo "No trace files in pages"
        - ls -la .next/standalone/*.json || echo "No JSON files in root"
        - echo "Checking main .next/server for comparison:"
        - find .next/server/app -name "*.nft.json" | head -10 || echo "No .nft.json in main build"
        # Create .env.production for Lambda runtime
        - echo "DATABASE_URL=$DATABASE_URL" > .next/standalone/.env.production
        - echo "AUTH_SECRET=$AUTH_SECRET" >> .next/standalone/.env.production
        - echo "NEXTAUTH_SECRET=$NEXTAUTH_SECRET" >> .next/standalone/.env.production
        - echo "NEXTAUTH_URL=$NEXTAUTH_URL" >> .next/standalone/.env.production
        - echo "UPSTASH_REDIS_REST_URL=$UPSTASH_REDIS_REST_URL" >> .next/standalone/.env.production
        - echo "UPSTASH_REDIS_REST_TOKEN=$UPSTASH_REDIS_REST_TOKEN" >> .next/standalone/.env.production
        # S3 environment variables for team logo uploads
        - echo "S3_ACCESS_KEY_ID=$S3_ACCESS_KEY_ID" >> .next/standalone/.env.production
        - echo "S3_SECRET_ACCESS_KEY=$S3_SECRET_ACCESS_KEY" >> .next/standalone/.env.production
        - echo "S3_BUCKET=$S3_BUCKET" >> .next/standalone/.env.production
        - echo "S3_REGION=$S3_REGION" >> .next/standalone/.env.production
        - echo "=== Created .env.production for Lambda runtime ==="
        # Check standalone output size
        - echo "=== Standalone output size ==="
        - du -sh .next/standalone
  artifacts:
    baseDirectory: .next/standalone
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

