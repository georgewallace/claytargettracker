version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - node --version
        - npm ci
        - npx prisma generate
        # Verify Prisma binaries were generated
        - echo "Checking for Prisma binaries..."
        - ls -la node_modules/.prisma/client/*.node || echo "Prisma binaries not found!"
        # Create database directory if it doesn't exist
        - mkdir -p prisma
        # Run migrations (will create SQLite database)
        - npx prisma migrate deploy || echo "Migration failed, continuing..."
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .
    files:
      - '.next/**/*'
      - 'node_modules/.prisma/client/**/*'
      - 'node_modules/@prisma/client/**/*'
      - 'node_modules/**/*'
      - 'package.json'
      - 'prisma/**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Strict-Transport-Security'
          value: 'max-age=31536000; includeSubDomains'
        - key: 'X-Frame-Options'
          value: 'SAMEORIGIN'
        - key: 'X-Content-Type-Options'
          value: 'nosniff'

