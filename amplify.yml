version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm install 20
        - nvm use 20
        - node --version
        - npm ci
        - npx prisma generate
        # Verify Prisma binaries were generated
        - echo "Checking for Prisma binaries..."
        - ls -la node_modules/.prisma/client/*.node || echo "Prisma binaries not found!"
        # Run database migrations (PostgreSQL via DATABASE_URL env var)
        - npx prisma migrate deploy
    build:
      commands:
        - npm run build
        # Verify Prisma binaries were generated
        - echo "=== Verifying Prisma binaries for AWS Lambda ==="
        - find node_modules/.prisma/client -name "*rhel-openssl-3.0.x.so.node" -ls || echo "RHEL binary NOT FOUND!"
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

