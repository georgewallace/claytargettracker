// SQLite schema for local development
// This is your Prisma schema file for LOCAL DEVELOPMENT ONLY
// Uses SQLite for fast local development without needing PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  firstName String?
  lastName  String?
  phone     String?
  password  String
  role      String   @default("athlete") // athlete, coach, admin
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  athlete            Athlete?
  createdTournaments Tournament[]
  coachedTeams       TeamCoach[] // Many-to-many relationship for coaches
  coachJoinRequests  CoachJoinRequest[]
  apiKeys            ApiKey[]
}

model Team {
  id               String   @id @default(cuid())
  name             String
  logoUrl          String?  // URL/path to team logo
  affiliation      String?  // USAYESS, SCTP, High School Clay Target Team, Other
  headCoach        String?
  headCoachEmail   String?
  headCoachPhone   String?
  address          String?
  city             String?
  state            String?
  zip              String?
  isIndividualTeam Boolean  @default(false) // True if this is an "Individual Competitors" team for a tournament
  tournamentId     String?  // If isIndividualTeam=true, links to the tournament
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  coaches             TeamCoach[] // Many-to-many relationship for coaches
  athletes            Athlete[]
  joinRequests        TeamJoinRequest[]
  coachJoinRequests   CoachJoinRequest[]
  tournamentRegistrations TeamTournamentRegistration[]
  squads              Squad[]
}

model TeamCoach {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  role      String   @default("coach") // coach, head_coach, assistant_coach
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, userId]) // A user can only be a coach once per team
  @@index([teamId])
  @@index([userId])
}

model TeamJoinRequest {
  id        String   @id @default(cuid())
  teamId    String
  athleteId String
  status    String   @default("pending") // pending, approved, rejected
  message   String?  // Optional message from athlete
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team    Team    @relation(fields: [teamId], references: [id], onDelete: Cascade)
  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  @@unique([teamId, athleteId]) // One request per athlete per team
  @@index([teamId])
  @@index([athleteId])
  @@index([status])
}

model CoachJoinRequest {
  id        String   @id @default(cuid())
  teamId    String
  userId    String
  status    String   @default("pending") // pending, approved, rejected
  message   String?  // Optional message from coach
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId]) // One request per coach per team
  @@index([teamId])
  @@index([userId])
  @@index([status])
}

model Athlete {
  id                String   @id @default(cuid())
  userId            String   @unique
  teamId            String?
  shooterId         String?  @unique // Format: YY-XXXX (e.g., "24-1000") for Excel import matching
  birthDay          Int?     // 1-31
  birthMonth        Int?     // 1-12
  birthYear         Int?     // e.g., 2008
  gender            String?  // "male", "female", "other"
  nscaClass         String?  // NSCA classification
  ataClass          String?  // ATA classification
  nssaClass         String?  // NSSA classification
  grade             String?  // "6", "7", "8", "9", "10", "11", "12", "College"
  division          String?  // Auto-calculated: Novice, Intermediate, Junior Varsity, Varsity, Collegiate, Open, Unassigned
  divisionOverride  String?  // Coach can manually override auto-calculated division
  isActive          Boolean  @default(true) // Active athletes can compete; inactive are aged out or transferred
  ataNumber         String?  // ATA membership number
  nscaNumber        String?  // NSCA membership number
  nssaNumber        String?  // NSSA membership number
  profilePictureUrl String?  // URL/path to profile picture
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team?    @relation(fields: [teamId], references: [id])
  
  registrations       Registration[]
  shoots              Shoot[]
  squadMembers        SquadMember[]
  teamJoinRequests    TeamJoinRequest[]
  averages            AthleteAverage[]
  shootOffWins        ShootOff[] @relation("ShootOffWinner")
  shootOffParticipations ShootOffParticipant[]
}

model AthleteAverage {
  id           String   @id @default(cuid())
  athleteId    String
  disciplineId String
  average      Float    // Current average score
  isManual     Boolean  @default(false) // True if manually set, false if auto-calculated
  lastUpdated  DateTime @default(now()) @updatedAt
  createdAt    DateTime @default(now())
  
  athlete    Athlete              @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  discipline TournamentDiscipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  
  @@unique([athleteId, disciplineId]) // One average per athlete per discipline
  @@index([athleteId])
  @@index([disciplineId])
}

model Tournament {
  id          String   @id @default(cuid())
  name        String
  location    String
  startDate   DateTime // Tournament start date
  endDate     DateTime // Tournament end date
  description String?
  status      String   @default("upcoming") // upcoming, active, finalizing, completed
  createdById String
  
  // HAA/HOA Configuration
  enableHOA           Boolean @default(true)  // Enable High Over All award
  enableHAA           Boolean @default(true)  // Enable High All-Around award
  hoaSeparateGender   Boolean @default(false) // Separate male/female for HOA
  haaCoreDisciplines  String? // JSON array of discipline IDs for HAA (e.g., ["trap", "skeet", "sporting_clays"])
  hoaExcludesHAA      Boolean @default(true)  // If true, HOA winners can't win HAA
  haaExcludesDivision Boolean @default(true)  // If true, HAA winners can't win 1st in their division
  haaOverallPlaces    Int?    @default(2)     // Number of places to award for HAA Overall (from Tournament Setup sheet)
  haaMenPlaces        Int?    @default(2)     // Number of places to award for HAA Men (from Tournament Setup sheet)
  haaLadyPlaces       Int?    @default(2)     // Number of places to award for HAA Lady (from Tournament Setup sheet)
  hoaOverallPlaces    Int?    @default(0)     // Number of places to award for HOA Overall (from Tournament Setup sheet)
  hoaMenPlaces        Int?    @default(2)     // Number of places to award for HOA Men per discipline (from Tournament Setup sheet)
  hoaLadyPlaces       Int?    @default(2)     // Number of places to award for HOA Lady per discipline (from Tournament Setup sheet)

  // Shoot-Off Configuration
  enableShootOffs          Boolean @default(false)  // Enable shoot-offs for this tournament
  shootOffTriggers         String? // JSON: when to trigger shoot-offs (e.g., ["podium", "top5", "perfect"])
  shootOffFormat           String  @default("sudden_death") // sudden_death, fixed_rounds, progressive
  shootOffTargetsPerRound  Int     @default(2) // Number of targets per round in shoot-off
  shootOffStartStation     String? // For discipline-specific shoot-offs (e.g., "station_4")
  shootOffRequiresPerfect  Boolean @default(false) // Only shoot off if at least one shooter has perfect score

  // Feature Toggles
  enableScores            Boolean @default(false)  // Enable score entry
  enableLeaderboard       Boolean @default(false)  // Enable leaderboard
  leaderboardTabInterval  Int?    @default(15000)  // Leaderboard tab switching interval in milliseconds

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  createdBy     User                      @relation(fields: [createdById], references: [id])
  disciplines   TournamentDiscipline[]
  registrations Registration[]
  shoots        Shoot[]
  timeSlots     TimeSlot[]
  shootOffs     ShootOff[]
  teamRegistrations TeamTournamentRegistration[]
}

model TeamTournamentRegistration {
  id           String   @id @default(cuid())
  teamId       String
  tournamentId String
  registeredBy String   // userId of coach who registered the team
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  team       Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)

  @@unique([teamId, tournamentId]) // A team can only be registered once per tournament
  @@index([teamId])
  @@index([tournamentId])
}

model TimeSlot {
  id           String   @id @default(cuid())
  tournamentId String
  disciplineId String
  date         DateTime // Which day of the tournament
  startTime    String   // Format: "HH:MM" (24-hour)
  endTime      String   // Format: "HH:MM" (24-hour)
  squadCapacity Int     @default(5) // Number of athletes per squad
  fieldNumber  String?  // For skeet/trap - e.g., "Field 1", "Field 2"
  stationNumber String? // For sporting clays - e.g., "Station 1", "Station 2"
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  discipline Discipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  squads     Squad[]
  preferences TimeSlotPreference[]

  @@index([tournamentId, date])
  @@index([disciplineId])
}

model Squad {
  id         String   @id @default(cuid())
  timeSlotId String
  teamId     String?  // null = Unaffiliated squad
  name       String   // e.g., "Squad A", "Squad 1"
  capacity   Int      @default(5)
  teamOnly   Boolean  @default(false) // If true, only athletes from the same team can join
  notes      String?
  division   String?  // Squad division (e.g., "Varsity", "Junior Varsity", "Open")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  timeSlot TimeSlot      @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  team     Team?         @relation(fields: [teamId], references: [id], onDelete: SetNull)
  members  SquadMember[]

  @@index([timeSlotId])
  @@index([teamId])
  @@index([division])
}

model SquadMember {
  id         String   @id @default(cuid())
  squadId    String
  athleteId  String
  position   Int?     // Optional position in squad (1-5 typically)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  squad   Squad   @relation(fields: [squadId], references: [id], onDelete: Cascade)
  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  
  @@unique([squadId, athleteId]) // An athlete can only be in a squad once
  @@index([squadId])
  @@index([athleteId])
}

model Discipline {
  id          String   @id @default(cuid())
  name        String   @unique // sporting_clays, five_stand, skeet, trap
  displayName String   // Sporting Clays, 5-Stand, Skeet, Trap
  description String?
  
  tournaments TournamentDiscipline[]
  registrations RegistrationDiscipline[]
  shoots      Shoot[]
  timeSlots   TimeSlot[]
  shootOffs   ShootOff[]
}

model TournamentDiscipline {
  id           String @id @default(cuid())
  tournamentId String
  disciplineId String
  
  // Discipline-specific configuration
  rounds       Int?   // For Trap/Skeet - number of rounds (e.g., 1, 2, 3)
  targets      Int?   // For 5-Stand/Sporting Clays - total number of targets
  stations     Int?   // For Sporting Clays - number of stations
  
  tournament      Tournament       @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  discipline      Discipline       @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  shooterAverages AthleteAverage[]
  
  @@unique([tournamentId, disciplineId])
}

model Registration {
  id           String   @id @default(cuid())
  tournamentId String
  athleteId    String
  status       String   @default("registered") // registered, checked_in, withdrawn
  createdAt    DateTime @default(now())
  
  tournament  Tournament                 @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  athlete     Athlete                    @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  disciplines RegistrationDiscipline[]
  
  @@unique([tournamentId, athleteId])
}

model RegistrationDiscipline {
  id             String @id @default(cuid())
  registrationId String
  disciplineId   String
  assignedBy     String? // userId of coach who assigned this (null if self-selected)

  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  discipline   Discipline   @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  timeSlotPreferences TimeSlotPreference[]

  @@unique([registrationId, disciplineId])
}

model TimeSlotPreference {
  id                     String   @id @default(cuid())
  registrationDisciplineId String
  timeSlotId             String
  preference             Int      @default(1) // 1 = first choice, 2 = second choice, etc.
  createdAt              DateTime @default(now())

  registrationDiscipline RegistrationDiscipline @relation(fields: [registrationDisciplineId], references: [id], onDelete: Cascade)
  timeSlot               TimeSlot @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)

  @@unique([registrationDisciplineId, timeSlotId])
  @@index([registrationDisciplineId])
  @@index([timeSlotId])
}

model Shoot {
  id                  String   @id @default(cuid())
  tournamentId        String
  athleteId           String
  disciplineId        String
  date                DateTime @default(now())
  notes               String?
  concurrentPlace     Int?
  classPlace          Int?
  teamPlace           Int?
  hoaPlace            Int?
  individualRank      Int?
  teamRank            Int?
  teamScore           Int?
  haaIndividualPlace  Int?
  haaConcurrent       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  athlete    Athlete    @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  discipline Discipline @relation(fields: [disciplineId], references: [id], onDelete: Cascade)
  scores     Score[]

  @@unique([tournamentId, athleteId, disciplineId])
}

model Score {
  id            String   @id @default(cuid())
  shootId       String
  roundNumber   Int?     // For Skeet/Trap: 1-4 (null if station-based)
  stationNumber Int?     // For Sporting Clays: 1-20 (null if round-based)
  targets       Float    // Number of targets hit (can include decimals for tie-breaking)
  maxTargets    Int      @default(25) // Maximum possible targets (typically 25 for rounds)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  shoot Shoot @relation(fields: [shootId], references: [id], onDelete: Cascade)

  @@index([shootId])
  @@index([shootId, roundNumber])
  @@index([shootId, stationNumber])
}

model ShootOff {
  id           String   @id @default(cuid())
  tournamentId String
  disciplineId String?  // Optional - if shoot-off is for specific discipline
  position     Int      // What position is being decided (1=1st place, 2=2nd, etc.)
  status       String   @default("pending") // pending, in_progress, completed, cancelled
  format       String   // sudden_death, fixed_rounds, progressive
  description  String?  // e.g., "1st Place Shoot-Off - Trap"
  startedAt    DateTime?
  completedAt  DateTime?
  winnerId     String?  // Final winner of shoot-off
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  tournament   Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  discipline   Discipline? @relation(fields: [disciplineId], references: [id])
  winner       Athlete? @relation("ShootOffWinner", fields: [winnerId], references: [id])
  participants ShootOffParticipant[]
  rounds       ShootOffRound[]
  
  @@index([tournamentId])
  @@index([status])
}

model ShootOffParticipant {
  id          String   @id @default(cuid())
  shootOffId  String
  athleteId   String
  tiedScore   Int      // Original score that caused the shoot-off
  finalPlace  Int?     // Final placement after shoot-off (1, 2, 3, etc.)
  eliminated  Boolean  @default(false)
  eliminatedInRound Int? // Which round they were eliminated
  createdAt   DateTime @default(now())
  
  shootOff  ShootOff @relation(fields: [shootOffId], references: [id], onDelete: Cascade)
  athlete   Athlete  @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  scores    ShootOffScore[]
  
  @@unique([shootOffId, athleteId]) // Each athlete can only be in a shoot-off once
  @@index([shootOffId])
  @@index([athleteId])
}

model ShootOffRound {
  id          String   @id @default(cuid())
  shootOffId  String
  roundNumber Int      // 1, 2, 3, etc.
  targets     Int      // Number of targets in this round
  station     String?  // Specific station if applicable (e.g., "Station 4")
  difficulty  String?  // standard, challenging, extreme
  notes       String?  // Additional notes about the round
  completedAt DateTime?
  createdAt   DateTime @default(now())
  
  shootOff ShootOff @relation(fields: [shootOffId], references: [id], onDelete: Cascade)
  scores   ShootOffScore[]
  
  @@unique([shootOffId, roundNumber])
  @@index([shootOffId])
}

model ShootOffScore {
  id            String   @id @default(cuid())
  roundId       String
  participantId String
  targetsHit    Int      // Number of targets hit in this round
  totalTargets  Int      // Total targets in this round
  notes         String?  // Optional notes about performance
  createdAt     DateTime @default(now())
  
  round       ShootOffRound        @relation(fields: [roundId], references: [id], onDelete: Cascade)
  participant ShootOffParticipant  @relation(fields: [participantId], references: [id], onDelete: Cascade)
  
  @@unique([roundId, participantId]) // One score per participant per round
  @@index([roundId])
  @@index([participantId])
}


// Imported Tournament Results (POC) - from Excel uploads
model ImportedScore {
  id               String   @id @default(cuid())
  shooter          String   // Shooter name
  team             String   // Team name
  gender           String   // "Men" or "Ladies"
  division         String   // "Novice", "Intermediate", "JV", "Varsity", "Collegiate"
  discipline       String   // "Trap", "Skeet", "Sporting Clays", etc.
  round            Int      // Round number
  targetsThrown    Int      // Total targets thrown
  targetsHit       Int      // Total targets hit
  stationBreakdown String?  // Optional: "5,5,4,4,5" (hits per station)
  field            String?  // Optional: Field identifier
  time             String?  // Optional: Time slot
  notes            String?  // Optional: Additional notes
  uploadedBy       String   // User ID of admin who uploaded
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([shooter])
  @@index([team])
  @@index([discipline])
  @@index([division])
  @@index([gender])
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  userId      String
  isActive    Boolean   @default(true)
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([key])
}
